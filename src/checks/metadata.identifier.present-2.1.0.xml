<?xml version="1.0" encoding="UTF-8"?>
<mdq:check xmlns:mdq="https://nceas.ucsb.edu/mdqe/v1.2" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="https://nceas.ucsb.edu/mdqe/v1.2 ../schemas/schema1.2.xsd">
  <id>metadata.identifier.present-2.1.0</id>
  <name>Metadata Identifier Present</name>
  <description>Check that a metadata identifier exists.</description>
  <type>Findable</type>
  <level>REQUIRED</level>
  <environment>python</environment>
  <code><![CDATA[
def call():
  import metadig.variable as mvar

  # These global variables are read by the quality engine when
  # the check returns
  global output
  global status
  
  global metadataIdentifier

  # check if metadata identifier is present
  if 'metadataIdentifier' not in globals() or metadataIdentifier is None:
    output = "A metadata identifier was not found."
    status = "FAILURE"
    return False
     
  metadataIdentifier = mvar.toUnicode(metadataIdentifier)
  
  # This should only be a single value, but if not (a list is returned) just get the first 
  # one
  # if(isinstance(metadataIdentifier, list)):
  #  metadataIdentifierSingle = metadataIdentifier[0]
    
  if (mvar.isBlank(metadataIdentifier)):
    output = "The metadata identifier is blank."
    status = "FAILURE"
    return False
  else:
    if isinstance(metadataIdentifier, list):
      formatted_id = ', '.join(str(id).strip() for id in metadataIdentifier if id is not None)
    else:
      formatted_id = str(metadataIdentifier).strip()

    output = "The metadata identifier '{}' was found.".format(formatted_id)
    status = "SUCCESS"
    return True 
    
  # Check if the identifier is an authority id (DOI, ARK, CURIE, RRID)
  # doi:, https://doi.org/, urn, http:, https:, ark:, RRID:
   ]]></code>
  <selector>
    <name>metadataIdentifier</name>
    <xpath>/resource/identifier |
             /*/fileIdentifier |
             /eml/@packageId
      </xpath>
      <expression syntax="json-path">.identifier as $id | ($id[]?.value? // $id.value? // $id) | [select(. != null)]</expression>
  </selector>
  <dialect>
    <name>DataCite 4</name>
    <xpath>boolean(/*[local-name() = 'resource'])</xpath>
  </dialect>
  <dialect>
    <name>Ecological Metadata Language</name>
    <xpath>boolean(/*[local-name() = 'eml'])</xpath>
  </dialect>
  <dialect>
    <name>ISO 19115 and ISO 19115-2 / ISO 19139 and ISO 19139-2</name>
    <xpath>boolean(/*[local-name() = 'MI_Metadata' or local-name() = 'MD_Metadata'])</xpath>
  </dialect>
  <dialect>
    <name>Schema.org</name>
    <expression syntax="json-path">.["@context"]</expression>
  </dialect>
</mdq:check>
